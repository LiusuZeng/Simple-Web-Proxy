#include <stdio.h>
#include <stdlib.h>
#include <pthread.h>
#include <string.h>

#define MY_FILE "mutex_test"

void* dosth(char* src);

pthread_mutex_t mutex;

int main()
{
  pthread_t tid;
  string a = "Tom";
  string b = "Jerry";
  char* op1 = &a[0];
  char* op2 = &b[0];
  //
  pthread_mutex_init(&mutex, NULL);
  //
  pthread_create(&tid, NULL, (void*)(dosth), (void*)(op1)); // Tom
  pthread_create(&tid, NULL, (void*)(dosth), (void*)(op2)); // Jerry
  //
  pthread_mutex_destroy(&mutex);
  //
  return EXIT_SUCCESS;
}

void* dosth(char* src)
{
  pthread_mutex_lock(&mutex);
  // Acquire lock
  FILE* fp;
  char buf[128];
  if((fp=fopen(MY_FILE, "w")) == NULL) {
    printf("Thread %s: cannot open file!\n", src);
  }
  else {
    while((strlen(gets(buf))) != 0) {
      fputs(buf, fp);
      fputs("\n", fp);
    }
    //
    fclose(fp);
  }
  // Release lock
  pthread_mutex_unlock(&mutex);
  return;
}
